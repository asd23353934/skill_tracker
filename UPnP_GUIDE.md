# 🌐 自動跨網路連線（UPnP）

## 🎯 目標

**讓不同網路的玩家能夠輕鬆連線，無需手動設定**

---

## ⚡ 快速開始

### Step 1: 安裝 UPnP 套件

```bash
pip install miniupnpc
```

### Step 2: 創建房間

```
點擊「創建房間」→ 自動完成以下步驟：
1. ✅ 獲取外網 IP
2. ✅ 自動設定路由器端口轉發
3. ✅ 生成包含外網 IP 的房間代碼
4. ✅ 啟動伺服器

完成！其他玩家可以從任何網路加入
```

### Step 3: 分享房間代碼

```
房間代碼: XXXXXXXX-XXXX-XXXX
分享給朋友，他們可以從任何地方加入！
```

---

## 🔧 工作原理

### 傳統方式（需要手動設定）
```
你需要做的事：
1. 登入路由器管理頁面
2. 找到端口轉發設定
3. 手動新增規則
4. 查詢外網 IP
5. 修改程式配置

難度: ★★★★☆
```

### UPnP 自動方式（一鍵完成）
```
程式自動完成：
1. ✅ 搜尋路由器
2. ✅ 請求端口映射（9999）
3. ✅ 獲取外網 IP
4. ✅ 生成房間代碼

難度: ★☆☆☆☆
```

---

## 📊 控制台輸出範例

### 成功的情況
```
🔧 嘗試 UPnP 自動端口映射...
🔍 搜尋支援 UPnP 的路由器...
   使用 miniupnpc 設定端口映射...
   搜尋 UPnP 設備...
   找到 1 個設備
   外網 IP: 123.45.67.89
   內網 IP: 192.168.1.100
✅ 端口映射成功！
   外部端口: 9999
   內部地址: 192.168.1.100:9999

✅ UPnP 成功！使用外網 IP: 123.45.67.89
🌐 跨網路模式 - 外網 IP: 123.45.67.89
✅ 房間已創建
   房間代碼: XXYYZZ-AABB-CCDD
   主機 IP: 123.45.67.89
   模式: 跨網路（任何人都可加入）
```

### 失敗但仍可用的情況
```
🔧 嘗試 UPnP 自動端口映射...
⚠️ UPnP 模組未安裝，使用內網 IP
   安裝方式: pip install miniupnpc

🏠 區域網模式 - 內網 IP: 192.168.1.100
✅ 房間已創建
   房間代碼: AABBCC-DDEE-FFGG
   主機 IP: 192.168.1.100
   模式: 區域網（同 WiFi 才能加入）
```

---

## ✅ 支援的路由器

### 已測試可用
- ✅ TP-Link
- ✅ ASUS
- ✅ Netgear
- ✅ D-Link
- ✅ 小米路由器
- ✅ 華碩路由器
- ✅ 大部分家用路由器

### 可能不支援
- ❌ 公司/學校防火牆
- ❌ 對稱型 NAT
- ❌ UPnP 功能被關閉的路由器
- ❌ 4G/5G 行動網路

---

## 🔍 檢查路由器是否支援 UPnP

### 方法 1: 路由器設定頁面
```
1. 登入路由器: http://192.168.1.1
2. 找到「UPnP」或「NAT-PMP」設定
3. 確認是否啟用

如果找不到，搜尋「[路由器型號] UPnP 設定」
```

### 方法 2: 使用測試腳本
```bash
cd SkillTracker
python -c "from src.core.upnp_manager import test_upnp; test_upnp()"
```

**輸出範例：**
```
找到 1 個設備
✅ 端口映射成功！
→ 你的路由器支援 UPnP ✅

沒有找到設備
→ 你的路由器可能不支援或 UPnP 被關閉 ❌
```

---

## 🛠️ 疑難排解

### 問題 1: UPnP 自動設定失敗

#### 解決方案 A: 啟用路由器 UPnP
```
1. 登入路由器管理頁面
2. 找到「UPnP」設定
3. 啟用 UPnP
4. 重新創建房間
```

#### 解決方案 B: 安裝 miniupnpc
```bash
# Windows
pip install miniupnpc

# Mac  
brew install miniupnpc
pip install miniupnpc

# Linux
sudo apt-get install python3-miniupnpc
```

#### 解決方案 C: 手動設定（備用）
參考 `NETWORK_SETUP.md` 進行手動端口轉發

---

### 問題 2: miniupnpc 安裝失敗

**Windows 錯誤：**
```
error: Microsoft Visual C++ 14.0 is required
```

**解決：**
1. 下載 Visual Studio Build Tools
2. 或使用預編譯版本：
   ```bash
   pip install miniupnpc-win64
   ```

**Mac 錯誤：**
```
error: command 'gcc' failed
```

**解決：**
```bash
xcode-select --install
brew install miniupnpc
pip install miniupnpc
```

---

### 問題 3: 仍然無法跨網路連線

**檢查清單：**
```
□ miniupnpc 是否安裝成功？
  python -c "import miniupnpc; print('OK')"

□ 路由器 UPnP 是否啟用？
  登入路由器檢查

□ 防火牆是否允許？
  Windows 防火牆允許程式

□ 是否使用了 VPN？
  VPN 可能阻擋 UPnP

□ 外網 IP 是否正確？
  訪問 https://www.whatismyip.com/
```

---

## 🔒 安全性考量

### UPnP 的風險
```
⚠️ UPnP 會在路由器上開啟端口
⚠️ 理論上可能被惡意軟體利用
```

### 安全建議
```
✅ 只在需要時創建房間
✅ 遊戲結束後關閉程式（自動清理端口映射）
✅ 不要分享房間代碼到公開論壇
✅ 只給信任的朋友
✅ 使用防毒軟體
```

### 自動清理
```
程式會在以下情況自動移除端口映射：
- 點擊「離開房間」
- 關閉程式
- 創建新房間（移除舊映射）
```

---

## 💡 最佳實踐

### 場景 1: 同地點（同 WiFi）
```
建議: 不啟用 UPnP
原因: 不需要，更簡單快速
方法: 直接創建房間（自動使用內網 IP）
```

### 場景 2: 固定隊友（跨網路）
```
建議: 使用 UPnP
原因: 一鍵設定，方便快速
方法: 安裝 miniupnpc + 創建房間
```

### 場景 3: 臨時組隊（不會設定）
```
建議: 使用遠端桌面或 Discord 螢幕分享
原因: 最簡單，無需設定
缺點: 畫質和延遲
```

---

## 📈 功能對比

| 功能 | 無 UPnP | 有 UPnP | 手動設定 |
|------|---------|---------|---------|
| 同 WiFi | ✅ | ✅ | ✅ |
| 跨網路 | ❌ | ✅ | ✅ |
| 設定難度 | 簡單 | 簡單 | 困難 |
| 需要套件 | 基本 | + miniupnpc | 基本 |
| 路由器要求 | 無 | 支援 UPnP | 支援端口轉發 |
| 自動化 | N/A | 完全自動 | 手動 |

---

## 🎮 使用流程

### 主機（創建房間）
```
1. 安裝 miniupnpc（一次性）
   pip install miniupnpc

2. 啟動程式

3. 點擊「創建房間」
   → 自動設定 UPnP
   → 顯示房間代碼

4. 分享代碼給朋友

5. 遊戲！

6. 結束後點「離開房間」
   → 自動清理端口映射
```

### 客戶端（加入房間）
```
1. 啟動程式

2. 點擊「加入房間」

3. 輸入房間代碼

4. 遊戲！
```

---

## 🆘 獲取幫助

如果 UPnP 不工作：
1. 檢查控制台錯誤訊息
2. 參考 `NETWORK_SETUP.md` 手動設定
3. 或使用同一 WiFi（最簡單）

---

最後更新: 2025-01-01
UPnP 版本: 1.0
