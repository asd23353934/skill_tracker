# 🌐 跨網路連線設定指南

## 📋 使用場景對照

| 場景 | 是否需要設定 | 適用方案 |
|------|------------|---------|
| 同一 WiFi | ❌ 不需要 | 直接使用 |
| 同一公司/學校網路 | ❌ 不需要 | 直接使用 |
| 網咖 | ❌ 不需要 | 直接使用 |
| 不同家庭網路 | ✅ 需要設定 | 見下方教學 |
| 宿舍 ↔ 家裡 | ✅ 需要設定 | 見下方教學 |
| 4G/5G 行動網路 | ❌ 無法使用 | 使用相同 WiFi |

---

## ✅ 同一網路（無需設定）

### 判斷方法
```
電腦 A 的 IP: 192.168.1.100
電腦 B 的 IP: 192.168.1.101
              ^^^^^^^^^ 前三段相同 → 同一網路 ✅
```

### 使用方式
1. 電腦 A：創建房間 → 得到代碼 `DAMTANEQ-PKQ8-K2SR`
2. 電腦 B：加入房間 → 輸入代碼
3. ✅ 完成！

---

## ⚠️ 跨網路設定（需要技術知識）

### 前置需求
- ✅ 主機有固定外網 IP（或使用 DDNS）
- ✅ 可以登入主機的路由器
- ✅ 主機電腦不會頻繁關機

### Step 1: 查詢外網 IP

**方法 1：網頁查詢**
```
訪問: https://www.whatismyip.com/
顯示: 123.45.67.89  ← 這就是你的外網 IP
```

**方法 2：程式內查詢**
```python
import requests
print(requests.get('https://api.ipify.org').text)
```

---

### Step 2: 設定端口轉發

#### **2.1 登入路由器**
```
1. 瀏覽器輸入路由器 IP（通常是）:
   - 192.168.1.1
   - 192.168.0.1
   - 10.0.0.1

2. 輸入帳號密碼（通常在路由器背面）
```

#### **2.2 找到端口轉發設定**
```
不同品牌路由器叫法不同：
- 「端口轉發」(Port Forwarding)
- 「虛擬伺服器」(Virtual Server)
- 「NAT 設定」(NAT Settings)
- 「應用程式及遊戲」(Applications & Gaming)
```

#### **2.3 新增轉發規則**
```
服務名稱: SkillTracker
外部端口: 9999
內部 IP:  192.168.1.100  ← 主機的內網 IP
內部端口: 9999
協定:     TCP
狀態:     啟用
```

**示意圖：**
```
Internet (外網)                路由器                    內網
                              ┌─────────┐
外網訪問                      │端口轉發  │
123.45.67.89:9999 ────────────→│9999→    │────→ 192.168.1.100:9999
                              │         │      (主機電腦)
                              └─────────┘
```

---

### Step 3: 設定防火牆

#### **Windows 防火牆**
```
1. 控制台 → 系統及安全性 → Windows Defender 防火牆
2. 進階設定
3. 輸入規則 → 新增規則
4. 規則類型：連接埠
5. 協定：TCP
6. 特定本機連接埠：9999
7. 動作：允許連線
8. 設定檔：全選
9. 名稱：SkillTracker
10. 完成
```

#### **防毒軟體**
```
如果使用第三方防毒軟體（如 Norton, Avast）:
1. 找到防火牆設定
2. 新增允許規則
3. 程式：技能追蹤器.exe
4. 端口：9999
5. 方向：輸入
```

---

### Step 4: 修改程式使用外網 IP

目前程式預設使用內網 IP，需要手動指定外網 IP。

#### **方法 1：修改 ip_encoder.py**
```python
# 找到 get_local_ip() 函數，改為：
def get_local_ip(self):
    """獲取本機 IP 地址"""
    # 跨網路使用：直接返回外網 IP
    return "123.45.67.89"  # ← 改成你的外網 IP
    
    # 同網路使用：自動獲取內網 IP（原本的代碼）
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.connect(("8.8.8.8", 80))
        ip = s.getsockname()[0]
        s.close()
        return ip
    except:
        return '127.0.0.1'
```

#### **方法 2：使用創建房間對話框**
```
（未來版本會提供 UI 選擇）
□ 使用內網 IP (192.168.1.100) - 同網路
□ 使用外網 IP (123.45.67.89)  - 跨網路
```

---

### Step 5: 測試連線

#### **5.1 主機端**
```
1. 啟動程式
2. 創建房間
3. 記下房間代碼: XXXXXXXX-XXXX-XXXX
```

#### **5.2 客戶端**
```
1. 啟動程式
2. 加入房間
3. 輸入代碼
4. 如果成功：顯示「成功加入房間」✅
5. 如果失敗：檢查以下項目
```

#### **5.3 除錯檢查清單**
```
□ 路由器端口轉發是否正確設定？
□ 防火牆是否允許 9999 端口？
□ 主機電腦是否開機且程式運行中？
□ 外網 IP 是否正確？
□ 房間代碼是否正確輸入？
□ 主機的內網 IP 是否改變？（重啟路由器後可能改變）
```

---

## 🔧 常見問題

### Q1: 動態 IP 怎麼辦？
```
問題：外網 IP 每次重啟路由器都會變
解決：使用 DDNS（動態域名服務）
      如：No-IP, DynDNS, 花生殼
```

### Q2: 4G/5G 可以當主機嗎？
```
❌ 不可以
原因：行動網路通常在 NAT 後面，沒有真實外網 IP
替代：兩台設備都連到同一個 WiFi
```

### Q3: 公司/學校網路可以用嗎？
```
同網段：✅ 可以（直接使用內網 IP）
跨網段：❌ 通常被防火牆阻擋
```

### Q4: 連線很慢/不穩定？
```
檢查：
1. 網路速度（上傳頻寬）
2. 路由器是否支援 UPnP
3. 是否有其他裝置佔用頻寬
4. 防毒軟體是否掃描網路流量
```

### Q5: 安全性考量？
```
風險：開放端口可能被掃描
建議：
1. 只在遊戲時開啟端口轉發
2. 使用強密碼保護路由器
3. 只分享房間代碼給信任的人
4. 遊戲結束後關閉端口轉發
```

---

## 📊 方案比較

| 方案 | 優點 | 缺點 | 難度 |
|------|------|------|------|
| 同一 WiFi | 無需設定、最穩定 | 距離受限 | ⭐☆☆☆☆ |
| 端口轉發 | 可跨網路 | 需要技術、安全性 | ⭐⭐⭐⭐☆ |
| VPN | 視為同網路 | 需要額外軟體 | ⭐⭐⭐☆☆ |
| 遠端桌面 | 最簡單 | 延遲高、畫質差 | ⭐⭐☆☆☆ |

---

## 💡 推薦方案

### 新手 / 同地點
```
→ 使用同一 WiFi（內網 IP）
  優點：簡單、穩定、安全
```

### 進階 / 跨地點 / 固定隊友
```
→ 設定端口轉發（外網 IP）
  適合：宿舍↔家裡、固定組隊
```

### 臨時 / 不會設定
```
→ 使用 VPN（如 Hamachi, ZeroTier）
  兩台電腦都安裝後視為同網路
```

---

## 📞 技術支援

如果以上方法都無法解決：
1. 檢查控制台輸出的錯誤訊息
2. 截圖路由器端口轉發設定
3. 回報以下資訊：
   - 路由器品牌型號
   - 網路環境（家用/公司/學校）
   - 錯誤訊息截圖
   - 是否有防毒軟體

---

最後更新: 2025-01-01
