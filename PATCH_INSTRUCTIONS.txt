"""
è‡¨æ™‚è£œä¸ - ç›´æ¥åœ¨ main_window.py ä¸­æ·»åŠ ä¸­ç¹¼ä¼ºæœå™¨æ–¹æ³•
å¦‚æœ NetworkManager çš„ create_room_relay ç„¡æ³•è¨ªå•ï¼Œä½¿ç”¨é€™å€‹è£œä¸
"""

# æŠŠé€™æ®µä»£ç¢¼æ·»åŠ åˆ° main_window.py çš„ MainWindow é¡åˆ¥è£¡é¢
# æ‰¾åˆ° _create_room æ–¹æ³•ï¼Œåœ¨å®ƒå‰é¢æ·»åŠ ï¼š

    def _create_room_relay_patched(self, player_name):
        """è‡¨æ™‚è£œä¸ï¼šç›´æ¥å‰µå»ºä¸­ç¹¼æˆ¿é–“"""
        try:
            import random
            import string
            from src.core.relay_client_http import RelayClientHTTP
            
            # ç”Ÿæˆæˆ¿é–“ä»£ç¢¼
            room_code = ''.join(random.choices(string.ascii_uppercase + string.digits, k=8))
            
            print(f"\nğŸ”‘ æˆ¿é–“ä»£ç¢¼: {room_code}")
            print(f"ğŸ”— é€£ç·šåˆ°ä¸­ç¹¼ä¼ºæœå™¨...")
            
            # å‰µå»ºä¸­ç¹¼å®¢æˆ¶ç«¯
            relay_client = RelayClientHTTP(
                room_code,
                player_name,
                self._on_network_skill,
                self._on_members_update
            )
            
            # é€£ç·š
            if relay_client.connect():
                # æ›´æ–° network ç‰©ä»¶çš„å±¬æ€§
                self.network.room_code = room_code
                self.network.is_host = True
                self.network.use_relay = True
                self.network.relay_client = relay_client
                
                print(f"\nâœ… ä¸­ç¹¼æˆ¿é–“å‰µå»ºæˆåŠŸ")
                print(f"   æˆ¿é–“ä»£ç¢¼: {room_code}")
                return room_code
            else:
                print(f"\nâŒ ä¸­ç¹¼ä¼ºæœå™¨é€£ç·šå¤±æ•—")
                return None
                
        except Exception as e:
            print(f"\nâŒ å‰µå»ºä¸­ç¹¼æˆ¿é–“å¤±æ•—: {e}")
            import traceback
            traceback.print_exc()
            return None
    
    def _join_room_relay_patched(self, room_code, player_name):
        """è‡¨æ™‚è£œä¸ï¼šç›´æ¥åŠ å…¥ä¸­ç¹¼æˆ¿é–“"""
        try:
            from src.core.relay_client_http import RelayClientHTTP
            
            print(f"\nğŸ”— é€éä¸­ç¹¼ä¼ºæœå™¨åŠ å…¥: {room_code}")
            
            # å‰µå»ºä¸­ç¹¼å®¢æˆ¶ç«¯
            relay_client = RelayClientHTTP(
                room_code,
                player_name,
                self._on_network_skill,
                self._on_members_update
            )
            
            # é€£ç·š
            if relay_client.connect():
                # æ›´æ–° network ç‰©ä»¶çš„å±¬æ€§
                self.network.room_code = room_code
                self.network.is_host = False
                self.network.use_relay = True
                self.network.relay_client = relay_client
                
                print(f"âœ… æˆåŠŸåŠ å…¥ä¸­ç¹¼æˆ¿é–“")
                return True
            else:
                print(f"âŒ åŠ å…¥ä¸­ç¹¼æˆ¿é–“å¤±æ•—")
                return False
                
        except Exception as e:
            print(f"âŒ åŠ å…¥ä¸­ç¹¼æˆ¿é–“éŒ¯èª¤: {e}")
            import traceback
            traceback.print_exc()
            return False

# ç„¶å¾Œä¿®æ”¹ _create_room æ–¹æ³•ï¼ŒæŠŠï¼š
#     room_code = self.network.create_room_relay(player_name)
# æ”¹æˆï¼š
#     room_code = self._create_room_relay_patched(player_name)

# ä¿®æ”¹ _join_room æ–¹æ³•ï¼ŒæŠŠï¼š
#     if self.network.join_room_relay(room_code, player_name):
# æ”¹æˆï¼š
#     if self._join_room_relay_patched(room_code, player_name):
